<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Foot Care Training</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    margin:0;
    padding:20px;
}
h2{text-align:center;}

.container{
    max-width:900px;
    margin:auto;
}

.cards{
    display:flex;
    gap:20px;
    justify-content:center;
    margin-bottom:20px;
}

.card{
    background:white;
    border-radius:12px;
    padding:20px;
    width:200px;
    text-align:center;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}

.big{
    font-size:32px;
    font-weight:bold;
    margin:10px 0;
}

button{
    background:#007bff;
    color:white;
    border:none;
    padding:10px 15px;
    border-radius:8px;
    cursor:pointer;
}
button:hover{background:#0056b3;}

.timer{
    text-align:center;
    font-size:28px;
    margin:20px 0;
}

.xyz{
    text-align:center;
    font-size:20px;
    margin-bottom:20px;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    margin-top:20px;
}
th,td{
    border:1px solid #ccc;
    padding:10px;
    text-align:center;
}
th{
    background:#007bff;
    color:white;
}

canvas{
    background:white;
    margin-top:30px;
    padding:10px;
    border-radius:12px;
}
</style>
</head>

<body>
<div class="container">
<h2>Foot Care Training</h2>

<!-- การ์ด -->
<div class="cards">
    <div class="card">
        <div>ยกเท้า (Dorsi)</div>
        <div class="big"><span id="dorsiSet">0</span> / 5</div>
        <button onclick="startSet('dorsi')">เริ่มยกเท้า</button>
    </div>

    <div class="card">
        <div>เหยียดเท้า (Plantar)</div>
        <div class="big"><span id="plantarSet">0</span> / 5</div>
        <button onclick="startSet('plantar')">เริ่มเหยียดเท้า</button>
    </div>
</div>

<!-- ตัวจับเวลา -->
<div class="timer">
⏱️ เวลา: <span id="timer">30</span> วินาที
</div>

<!-- แสดงค่า X Y Z จาก ESP32 -->
<div class="xyz">
X: <span id="xValue">0</span> |
Y: <span id="yValue">0</span> |
Z: <span id="zValue">0</span>
</div>

<!-- ตาราง -->
<table>
<thead>
<tr>
<th>เซท</th>
<th>Dorsi</th>
<th>Plantar</th>
<th>ROM</th>
</tr>
</thead>
<tbody id="resultTable">
<tr><td>1</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>2</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>3</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>4</td><td>-</td><td>-</td><td>-</td></tr>
<tr><td>5</td><td>-</td><td>-</td><td>-</td></tr>
</tbody>
</table>

<!-- กราฟ -->
<canvas id="chart" height="120"></canvas>

</div>

<script type="module">

// ================= Firebase =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyArB39e1jNG71QNBrSDGoXzQk7o4HE9SfM",
  databaseURL: "https://foot-care-15028-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "foot-care-15028",
  appId: "1:568507097776:web:5ecd08c79da53ed42f1175"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const liveRef = ref(db, "live");

// ================= ตัวแปร =================
let dorsiSet = 0;
let plantarSet = 0;
let timeLeft = 30;
let timer;

const timerEl = document.getElementById("timer");
const dorsiSetEl = document.getElementById("dorsiSet");
const plantarSetEl = document.getElementById("plantarSet");
const tableEl = document.getElementById("resultTable");

// ================= กราฟ =================
const chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "Dorsi", data: [], borderWidth:2 },
            { label: "Plantar", data: [], borderWidth:2 },
            { label: "ROM", data: [], borderWidth:2 }
        ]
    }
});

// ================= Firebase Live =================
onValue(liveRef, (snapshot) => {
  const data = snapshot.val();
  if(data){
    document.getElementById("xValue").innerText = data.dorsi ?? 0;
    document.getElementById("yValue").innerText = data.plantar ?? 0;
    document.getElementById("zValue").innerText = data.angleZ ?? 0;
  }
});

// ================= Timer =================
window.startSet = function(mode){

    if(mode==="dorsi" && dorsiSet>=5) return;
    if(mode==="plantar" && plantarSet>=5) return;

    clearInterval(timer);
    timeLeft = 30;
    timerEl.innerText = timeLeft;

    timer = setInterval(()=>{
        timeLeft--;
        timerEl.innerText = timeLeft;

        if(timeLeft<=0){
            clearInterval(timer);
            finishSet(mode);
        }
    },1000);
}

function finishSet(mode){

    let dorsi = parseFloat(document.getElementById("xValue").innerText);
    let plantar = parseFloat(document.getElementById("yValue").innerText);

    let rowIndex;

    if(mode==="dorsi"){
        dorsiSet++;
        dorsiSetEl.innerText = dorsiSet;
        rowIndex = dorsiSet-1;
        tableEl.rows[rowIndex].cells[1].innerText = dorsi.toFixed(1);
    }

    if(mode==="plantar"){
        plantarSet++;
        plantarSetEl.innerText = plantarSet;
        rowIndex = plantarSet-1;
        tableEl.rows[rowIndex].cells[2].innerText = plantar.toFixed(1);
    }

    let dVal = tableEl.rows[rowIndex].cells[1].innerText;
    let pVal = tableEl.rows[rowIndex].cells[2].innerText;

    if(dVal!=="-" && pVal!=="-"){
        let rom = Math.abs(parseFloat(dVal)) + Math.abs(parseFloat(pVal));
        tableEl.rows[rowIndex].cells[3].innerText = rom.toFixed(1);

        chart.data.labels.push("เซท "+(rowIndex+1));
        chart.data.datasets[0].data.push(dVal);
        chart.data.datasets[1].data.push(pVal);
        chart.data.datasets[2].data.push(rom);
        chart.update();
    }
}

</script>

</body>
</html>


</body>

</html>

